<!-- Pablo -->

<html>
	<head>
		<title>Crud - Cadastro</title>
	</head>
	<style>

		table tr td{
			border:1px solid grey;
			padding:10px
		}


	</style>

	<body>
		<nav>
			<button type="button" onclick="cadastrarContato()">Cadastrar Contato</button>
		</nav>
		<div id="listaContatos">
		</div>
		<div id="cadastroContato" style="display:none">
			<fieldset>
				<legend>Cadastrar Contato</legend>
				<form name="cadastroForm" id="cadastroForm" method="POST" action="crud2.php" onsubmit="return salvarContato()">
				<table>
					<tr>
						<td>
							<label for="nome">Nome:</label>
						</td>
						<td>
							<input type="text" name="nome" id="nome" required/>
						</td>
					</tr>
					<tr>
						<td>
							<label for="telefone">Telefone:</label>
						</td>
						<td>
							<input type="text" name="telefone" id="telefone" required/>
						</td>
					</tr>
					<tr>
						<td colspan="2" style="text-align:right">
							<button type="submit">Enviar</button>
						</td>
					</tr>
				</table>
			</form>
			</fieldset>
		</div>

	</body>
	<script type="text/javascript" src="jquery.js"></script>
	<script type="text/javascript">

	var imprimirContatos = function(contatos) {
				if(typeof contatos == 'string') {
					contatos = JSON.parse(contatos);
				}

				var html = '', nome;

				if(contatos.length > 0) {
					html = '<table><tr><th>Nome</th><th>Telefone</th><th>Opcoes</th></tr>';

					$(contatos).each(function(index, contato) {

						html += '<tr>' +
							'<td>' + contato.nome + '</td>' +
							'<td>' + contato.telefone + '</td>' +
							'<td>' +
								"<button type='button' onclick='alterarContato(\"" + contato.nome + "\")'>Alterar</button>" +
								"<button type='button' onclick='excluirContato(\"" + contato.nome + "\")'>Excluir</button>" +
							'</td></tr>';

					});

					html += '</table>';
				}

				$("#listaContatos").html(html);

			}

		function cadastrarContato() {
			$("#cadastroContato").show();
			$("#cadastroForm").attr("method", "POST");
			$("#cadastroForm").attr("action", "crud2.php");
			$("#nome").val('');
			$("#telefone").val('');
		}


		function alterarContato (nome) {
			$.get(
				'crud2.php',
				{nome:nome},
				function(response) {
					$("#cadastroContato").show();
					$("#cadastroForm").attr("method", "PUT");
					$("#cadastroForm").attr("action", "crud2.php?nome=" + response.nome);
					$("#nome").val(response.nome);
					$("#telefone").val(response.telefone);
				}
			);
		};

		function excluirContato (nome) {
			if(confirm('Deseja realmente excluir o contato ' + nome + '?')) {
				$.ajax({
					url:'crud2.php?nome=' + nome,
					type:'DELETE',
					success: function(response) {
						console.log(response);
						alert("Contato excluido com sucesso");
						imprimirContatos(response);
					},
					fail: function(response) {
						console.error(response);
					}
				});
			}
		}

		var salvarContato = function(){
			var method = $("#cadastroForm").attr("method");
			var action = $("#cadastroForm").attr("action");
			var contato = {
				nome:$("#nome").val(),
				telefone:$("#telefone").val(),
			};

			$.ajax({
				url:action,
				type:method,
				data:contato,
				success: function(response) {
					alert("Contato salvo com sucesso");
					imprimirContatos(response);
				},
				fail: function(response) {
					console.error(response);
				}
			});

			return false;
		};



		$(document).ready(function() {

			var getContatos = function () {

				$.ajax(
					{
						type:'GET',
						url:'crud2.php',
						success: function(response) {
							imprimirContatos(response);
						},
						fail:function(response) {
							console.error(response);
						}
					});
			};




			getContatos();

		});






	</script>
</html>
